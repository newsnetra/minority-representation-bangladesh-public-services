<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  .custom-lollipop-chart svg {
    width: 100%;
    height: auto;
  }
  .custom-lollipop-chart .toggle-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 16px;
  }
  .custom-lollipop-chart .toggle-container button {
    padding: 8px 16px;
    font-size: 15px;
    font-weight: 500;
    border: 1px solid #c74c3d;
    border-radius: 6px;
    background: #fbece8;
    color: #c74c3d;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
  }
  .custom-lollipop-chart .toggle-container button:hover {
    background: #f7cdb8;
    border-color: #b13f32;
  }
  .custom-lollipop-chart .title {
    text-align: center;
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
  }
  .custom-lollipop-chart .legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 8px;
    font-size: 14px;
    font-family: 'Helvetica Neue', sans-serif;
  }
  .custom-lollipop-chart .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .custom-lollipop-chart .legend-circle {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  .custom-lollipop-chart .chart-container {
    min-height: 300px;
  }
  .custom-lollipop-chart text {
    font-family: 'Helvetica Neue', sans-serif;
    font-size: 12px;
    fill: #333;
  }
  .custom-lollipop-chart-tooltip {
    position: absolute;
    padding: 6px 10px;
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    box-shadow: 0px 2px 8px rgba(0,0,0,0.1);
  }
  .custom-lollipop-chart .source-note {
    margin-top: 16px;
    font-size: 13px;
    color: #444;
    font-family: 'Helvetica Neue', sans-serif;
    text-align: center;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
<div class="custom-lollipop-chart">
  <div class="title" id="chartTitle">Non-Muslim Representation in Government Institutions</div>
  <div class="toggle-container">
    <button id="toggleChartBtn">Switch to Muslim View</button>
  </div>
  <div class="legend">
    <div class="legend-item"><span class="legend-circle" style="background:#c74c3d"></span> National</div>
    <div class="legend-item"><span class="legend-circle" style="background:#f7cdb8"></span> Overall</div>
    <div class="legend-item"><span class="legend-circle" style="background:#c74c3d"></span> Top-tier</div>
  </div>
  <div class="chart-container"></div>
  <div class="source-note">
    Source: Public and confidential records obtained by Netra News. For details sourcing, please see <a href="https://interactive.netra.news/minority-representation-bangladesh-public-services/#app" target="_blank" style="color:#c74c3d; text-decoration: underline;">full methodology.</a><br><br>
    <em>Note:</em> For army, brigadier and above; for navy, commodore and above; for administration, secretary and above; for police, DIG and above; for judiciary, district judges and above; for Dhaka University, professor positions were considered for top-tier positions.
  </div>
</div>
<div id="customLollipopTooltip" class="custom-lollipop-chart-tooltip" style="opacity:0;"></div>
<script>
  const tooltip = d3.select("#customLollipopTooltip");

  function drawLollipopChart(containerSelector, dataSet, isMuslim = false) {
    const categories = ["National", "Overall", "Top"];
    const color = d3.scaleOrdinal()
      .domain(categories)
      .range(["#c74c3d", "#f7cdb8", "#c74c3d"]);

    const container = d3.select(containerSelector);
    const existingSVG = container.select("svg");
    if (!existingSVG.empty()) {
      existingSVG.transition()
        .duration(300)
        .style("opacity", 0)
        .on("end", function() {
          d3.select(this).remove();
          renderChart();
        });
    } else {
      renderChart();
    }

    function renderChart() {
      const margin = { top: 30, right: 160, bottom: 40, left: 200 },
            width = container.node().getBoundingClientRect().width - margin.left - margin.right,
            height = 400;

      const svgOuter = container.append("svg")
        .style("opacity", 0)
        .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height}`);

      svgOuter.transition().duration(300).style("opacity", 1);

      const svg = svgOuter.append("g")
        .attr("transform", `translate(${margin.left},20)`);

      const y = d3.scalePoint()
        .domain(dataSet.map(d => d.institution))
        .range([0, height - 40])
        .padding(0.5);

      const x = d3.scaleLinear()
        .domain([0, d3.max(dataSet.flatMap(d => [d.National, d.Overall, d.Top])) + 2])
        .range([0, width]);

      const ticks = x.ticks(3);
      svg.append("g")
        .attr("transform", `translate(0,${height - 40})`)
        .call(d3.axisBottom(x).tickValues([ticks[0], ticks[Math.floor(ticks.length / 2)], ticks[ticks.length - 1]]).tickFormat(d => d + "%"))
        .selectAll("text")
        .style("fill", "#333");

      svg.append("g")
        .call(d3.axisLeft(y).tickSize(-width).tickPadding(8))
        .call(g => g.select(".domain").remove())
        .call(g => g.selectAll(".tick line").attr("stroke", "#eee"))
        .call(g => g.selectAll("text").style("fill", "#333"));

      const lineGroup = svg.append("g");
      const dotGroup = svg.append("g");

      dataSet.forEach(d => {
        lineGroup.append("line")
          .attr("x1", x(d.National))
          .attr("x2", x(d.Overall))
          .attr("y1", y(d.institution))
          .attr("y2", y(d.institution))
          .attr("stroke", "#ddd")
          .attr("stroke-width", 1);

        lineGroup.append("line")
          .attr("x1", x(d.Overall))
          .attr("x2", x(d.Top))
          .attr("y1", y(d.institution))
          .attr("y2", y(d.institution))
          .attr("stroke", "#ddd")
          .attr("stroke-width", 1);
      });

      categories.forEach(cat => {
        dotGroup.selectAll(`.dot-${cat}`)
          .data(dataSet)
          .join("circle")
          .attr("class", `dot-${cat}`)
          .attr("r", 6)
          .attr("cx", d => x(d[cat]))
          .attr("cy", d => y(d.institution))
          .attr("fill", color(cat))
          .style("cursor", "pointer")
          .on("mouseover", function (event, d) {
            d3.select(this).transition().duration(150).attr("r", 8);
            tooltip.transition().duration(150).style("opacity", 1);
            tooltip.html(`${cat}: ${d[cat]}%`)
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", function () {
            d3.select(this).transition().duration(150).attr("r", 6);
            tooltip.transition().duration(150).style("opacity", 0);
          });
      });
    }
  }

  const muslimData = [
    { institution: "Lower Court", National: 91.09, Overall: 89.85, Top: 95.81 },
    { institution: "Dhaka University", National: 91.09, Overall: 89.89, Top: 92.87 },
    { institution: "Bangladesh Navy", National: 91.09, Overall: 98.47, Top: 98.53 },
    { institution: "Bangladesh Police", National: 91.09, Overall: 90.85, Top: 93.83 },
    { institution: "Bangladesh Army", National: 91.09, Overall: 99.09, Top: 99.66 },
    { institution: "Public Administration", National: 91.09, Overall: 89.56, Top: 94.30 }
  ];

  const nonMuslimData = [
    { institution: "Lower Court", National: 8.91, Overall: 10.15, Top: 4.19 },
    { institution: "Dhaka University", National: 8.91, Overall: 10.11, Top: 7.13 },
    { institution: "Bangladesh Navy", National: 8.91, Overall: 1.53, Top: 1.47 },
    { institution: "Bangladesh Police", National: 8.91, Overall: 9.15, Top: 6.17 },
    { institution: "Bangladesh Army", National: 8.91, Overall: 0.91, Top: 0.34 },
    { institution: "Public Administration", National: 8.91, Overall: 10.44, Top: 5.70 }
  ];

  let currentView = 'nonMuslim';

  function toggleDataView() {
    currentView = currentView === 'nonMuslim' ? 'muslim' : 'nonMuslim';
    const isMuslim = currentView === 'muslim';
    drawLollipopChart(".custom-lollipop-chart .chart-container", isMuslim ? muslimData : nonMuslimData, isMuslim);
    document.getElementById("chartTitle").textContent = isMuslim ?
      "Muslim Representation in Government Institutions" :
      "Non-Muslim Representation in Government Institutions";
    document.getElementById("toggleChartBtn").textContent = isMuslim ?
      "Switch to Non-Muslim View" : "Switch to Muslim View";
  }

  document.getElementById("toggleChartBtn").addEventListener("click", toggleDataView);
  drawLollipopChart(".custom-lollipop-chart .chart-container", nonMuslimData);
</script>
